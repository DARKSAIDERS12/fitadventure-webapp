#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Веб-приложение для мини-приложения "База продуктов"
Telegram Web App API
"""

from flask import Flask, render_template, request, jsonify
import json
import os

app = Flask(__name__)

# === БАЗА ДАННЫХ ПРОДУКТОВ ===
PRODUCTS_DATABASE = {
    "похудение": {
        "сложные_углеводы": {
            "овсянка": {"калории": 389, "белки": 16.9, "жиры": 6.9, "углеводы": 66, "клетчатка": 10.6},
            "гречка": {"калории": 343, "белки": 13, "жиры": 3.4, "углеводы": 72, "клетчатка": 10},
            "киноа": {"калории": 120, "белки": 4.4, "жиры": 1.9, "углеводы": 22, "клетчатка": 2.8},
            "булгур": {"калории": 342, "белки": 12, "жиры": 1.3, "углеводы": 76, "клетчатка": 8},
            "рис бурый": {"калории": 337, "белки": 7.4, "жиры": 2.2, "углеводы": 73, "клетчатка": 3.5},
            "чечевица": {"калории": 116, "белки": 9, "жиры": 0.4, "углеводы": 20, "клетчатка": 7.9},
            "нут": {"калории": 164, "белки": 8.9, "жиры": 2.6, "углеводы": 27, "клетчатка": 7.6},
            "фасоль": {"калории": 127, "белки": 9, "жиры": 0.5, "углеводы": 23, "клетчатка": 6.4},
        },
        "простые_углеводы": {
            "мед": {"калории": 304, "белки": 0.3, "жиры": 0, "углеводы": 82, "клетчатка": 0},
            "фрукты": {"калории": 52, "белки": 0.3, "жиры": 0.2, "углеводы": 14, "клетчатка": 2.4},
            "сухофрукты": {"калории": 240, "белки": 3.4, "жиры": 0.4, "углеводы": 63, "клетчатка": 7.3},
        },
        "белки": {
            "куриная грудка": {"калории": 165, "белки": 31, "жиры": 3.6, "углеводы": 0, "клетчатка": 0},
            "индейка грудка": {"калории": 157, "белки": 29, "жиры": 3.6, "углеводы": 0, "клетчатка": 0},
            "яичные белки": {"калории": 52, "белки": 11, "жиры": 0.2, "углеводы": 0.7, "клетчатка": 0},
            "творог обезжиренный": {"калории": 88, "белки": 18, "жиры": 0.6, "углеводы": 1.8, "клетчатка": 0},
            "рыба белая": {"калории": 72, "белки": 16, "жиры": 0.9, "углеводы": 0, "клетчатка": 0},
            "креветки": {"калории": 99, "белки": 24, "жиры": 0.3, "углеводы": 0.2, "клетчатка": 0},
            "протеин изолят": {"калории": 350, "белки": 85, "жиры": 1, "углеводы": 5, "клетчатка": 0},
        },
        "ненасыщенные_жиры": {
            "авокадо": {"калории": 160, "белки": 2, "жиры": 15, "углеводы": 9, "клетчатка": 6.7},
            "оливковое масло": {"калории": 884, "белки": 0, "жиры": 100, "углеводы": 0, "клетчатка": 0},
            "орехи грецкие": {"калории": 654, "белки": 15, "жиры": 65, "углеводы": 14, "клетчатка": 6.7},
            "миндаль": {"калории": 579, "белки": 21, "жиры": 50, "углеводы": 22, "клетчатка": 12.5},
            "семена льна": {"калории": 534, "белки": 18, "жиры": 42, "углеводы": 29, "клетчатка": 27.3},
            "семена чиа": {"калории": 486, "белки": 17, "жиры": 31, "углеводы": 42, "клетчатка": 34.4},
        },
        "насыщенные_жиры": {
            "сливочное масло": {"калории": 717, "белки": 0.9, "жиры": 81, "углеводы": 0.1, "клетчатка": 0},
            "сыр твердый": {"калории": 350, "белки": 25, "жиры": 27, "углеводы": 0, "клетчатка": 0},
        },
        "клетчатка": {
            "брокколи": {"калории": 34, "белки": 2.8, "жиры": 0.4, "углеводы": 7, "клетчатка": 2.6},
            "цветная капуста": {"калории": 25, "белки": 1.9, "жиры": 0.3, "углеводы": 5, "клетчатка": 2.5},
            "шпинат": {"калории": 23, "белки": 2.9, "жиры": 0.4, "углеводы": 3.6, "клетчатка": 2.2},
            "капуста": {"калории": 25, "белки": 1.3, "жиры": 0.2, "углеводы": 5.8, "клетчатка": 2.5},
            "морковь": {"калории": 41, "белки": 0.9, "жиры": 0.2, "углеводы": 10, "клетчатка": 2.8},
            "свекла": {"калории": 43, "белки": 1.6, "жиры": 0.2, "углеводы": 10, "клетчатка": 2.8},
        }
    },
    
    "набор_массы": {
        "сложные_углеводы": {
            "рис белый": {"калории": 344, "белки": 6.7, "жиры": 0.7, "углеводы": 78, "клетчатка": 2.8},
            "рис бурый": {"калории": 337, "белки": 7.4, "жиры": 2.2, "углеводы": 73, "клетчатка": 3.5},
            "гречка": {"калории": 343, "белки": 13, "жиры": 3.4, "углеводы": 72, "клетчатка": 10},
            "овсянка": {"калории": 389, "белки": 16.9, "жиры": 6.9, "углеводы": 66, "клетчатка": 10.6},
            "макароны": {"калории": 371, "белки": 13, "жиры": 1.5, "углеводы": 75, "клетчатка": 3.2},
            "картофель": {"калории": 77, "белки": 2, "жиры": 0.1, "углеводы": 17, "клетчатка": 2.2},
            "батат": {"калории": 86, "белки": 1.6, "жиры": 0.1, "углеводы": 20, "клетчатка": 3},
        },
        "простые_углеводы": {
            "мед": {"калории": 304, "белки": 0.3, "жиры": 0, "углеводы": 82, "клетчатка": 0},
            "банан": {"калории": 89, "белки": 1.1, "жиры": 0.3, "углеводы": 23, "клетчатка": 2.6},
            "виноград": {"калории": 62, "белки": 0.6, "жиры": 0.2, "углеводы": 16, "клетчатка": 0.9},
            "сухофрукты": {"калории": 240, "белки": 3.4, "жиры": 0.4, "углеводы": 63, "клетчатка": 7.3},
        },
        "белки": {
            "куриная грудка": {"калории": 165, "белки": 31, "жиры": 3.6, "углеводы": 0, "клетчатка": 0},
            "говядина постная": {"калории": 250, "белки": 26, "жиры": 15, "углеводы": 0, "клетчатка": 0},
            "свинина постная": {"калории": 242, "белки": 27, "жиры": 14, "углеводы": 0, "клетчатка": 0},
            "яйца куриные": {"калории": 157, "белки": 12.7, "жиры": 11.5, "углеводы": 0.7, "клетчатка": 0},
            "лосось": {"калории": 208, "белки": 20, "жиры": 13, "углеводы": 0, "клетчатка": 0},
            "тунец": {"калории": 144, "белки": 30, "жиры": 1, "углеводы": 0, "клетчатка": 0},
            "творог 5%": {"калории": 121, "белки": 17, "жиры": 5, "углеводы": 1.8, "клетчатка": 0},
            "протеин сывороточный": {"калории": 375, "белки": 80, "жиры": 4, "углеводы": 8, "клетчатка": 0},
        },
        "ненасыщенные_жиры": {
            "орехи грецкие": {"калории": 654, "белки": 15, "жиры": 65, "углеводы": 14, "клетчатка": 6.7},
            "миндаль": {"калории": 579, "белки": 21, "жиры": 50, "углеводы": 22, "клетчатка": 12.5},
            "кешью": {"калории": 553, "белки": 18, "жиры": 44, "углеводы": 30, "клетчатка": 3.3},
            "арахис": {"калории": 567, "белки": 26, "жиры": 49, "углеводы": 16, "клетчатка": 8.5},
            "авокадо": {"калории": 160, "белки": 2, "жиры": 15, "углеводы": 9, "клетчатка": 6.7},
            "оливковое масло": {"калории": 884, "белки": 0, "жиры": 100, "углеводы": 0, "клетчатка": 0},
        },
        "насыщенные_жиры": {
            "сливочное масло": {"калории": 717, "белки": 0.9, "жиры": 81, "углеводы": 0.1, "клетчатка": 0},
            "сыр твердый": {"калории": 350, "белки": 25, "жиры": 27, "углеводы": 0, "клетчатка": 0},
            "сметана 20%": {"калории": 206, "белки": 2.5, "жиры": 20, "углеводы": 3.4, "клетчатка": 0},
        },
        "клетчатка": {
            "брокколи": {"калории": 34, "белки": 2.8, "жиры": 0.4, "углеводы": 7, "клетчатка": 2.6},
            "шпинат": {"калории": 23, "белки": 2.9, "жиры": 0.4, "углеводы": 3.6, "клетчатка": 2.2},
            "морковь": {"калории": 41, "белки": 0.9, "жиры": 0.2, "углеводы": 10, "клетчатка": 2.8},
            "яблоко": {"калории": 52, "белки": 0.3, "жиры": 0.2, "углеводы": 14, "клетчатка": 2.4},
            "груша": {"калории": 57, "белки": 0.4, "жиры": 0.1, "углеводы": 15, "клетчатка": 3.1},
        }
    },
    
    "поддержание": {
        "сложные_углеводы": {
            "овсянка": {"калории": 389, "белки": 16.9, "жиры": 6.9, "углеводы": 66, "клетчатка": 10.6},
            "гречка": {"калории": 343, "белки": 13, "жиры": 3.4, "углеводы": 72, "клетчатка": 10},
            "рис бурый": {"калории": 337, "белки": 7.4, "жиры": 2.2, "углеводы": 73, "клетчатка": 3.5},
            "киноа": {"калории": 120, "белки": 4.4, "жиры": 1.9, "углеводы": 22, "клетчатка": 2.8},
            "чечевица": {"калории": 116, "белки": 9, "жиры": 0.4, "углеводы": 20, "клетчатка": 7.9},
        },
        "простые_углеводы": {
            "мед": {"калории": 304, "белки": 0.3, "жиры": 0, "углеводы": 82, "клетчатка": 0},
            "фрукты": {"калории": 52, "белки": 0.3, "жиры": 0.2, "углеводы": 14, "клетчатка": 2.4},
        },
        "белки": {
            "куриная грудка": {"калории": 165, "белки": 31, "жиры": 3.6, "углеводы": 0, "клетчатка": 0},
            "индейка грудка": {"калории": 157, "белки": 29, "жиры": 3.6, "углеводы": 0, "клетчатка": 0},
            "творог 5%": {"калории": 121, "белки": 17, "жиры": 5, "углеводы": 1.8, "клетчатка": 0},
            "рыба белая": {"калории": 72, "белки": 16, "жиры": 0.9, "углеводы": 0, "клетчатка": 0},
        },
        "ненасыщенные_жиры": {
            "авокадо": {"калории": 160, "белки": 2, "жиры": 15, "углеводы": 9, "клетчатка": 6.7},
            "оливковое масло": {"калории": 884, "белки": 0, "жиры": 100, "углеводы": 0, "клетчатка": 0},
            "миндаль": {"калории": 579, "белки": 21, "жиры": 50, "углеводы": 22, "клетчатка": 12.5},
            "семена льна": {"калории": 534, "белки": 18, "жиры": 42, "углеводы": 29, "клетчатка": 27.3},
        },
        "насыщенные_жиры": {
            "сыр твердый": {"калории": 350, "белки": 25, "жиры": 27, "углеводы": 0, "клетчатка": 0},
        },
        "клетчатка": {
            "брокколи": {"калории": 34, "белки": 2.8, "жиры": 0.4, "углеводы": 7, "клетчатка": 2.6},
            "шпинат": {"калории": 23, "белки": 2.9, "жиры": 0.4, "углеводы": 3.6, "клетчатка": 2.2},
            "морковь": {"калории": 41, "белки": 0.9, "жиры": 0.2, "углеводы": 10, "клетчатка": 2.8},
        }
    }
}

def search_product(product_name):
    """Поиск продукта по названию"""
    results = {}
    product_name_lower = product_name.lower()
    
    for goal, categories in PRODUCTS_DATABASE.items():
        results[goal] = {}
        for category, products in categories.items():
            matches = {}
            for name, data in products.items():
                if product_name_lower in name.lower():
                    matches[name] = data
            if matches:
                results[goal][category] = matches
    
    return results

@app.route('/')
def index():
    """Главная страница веб-приложения"""
    return render_template('index.html')

@app.route('/api/products/<goal>')
def get_products_by_goal(goal):
    """API для получения продуктов по цели"""
    if goal in PRODUCTS_DATABASE:
        return jsonify(PRODUCTS_DATABASE[goal])
    return jsonify({})

@app.route('/api/search/<query>')
def search_products(query):
    """API для поиска продуктов"""
    results = search_product(query)
    return jsonify(results)

@app.route('/api/categories')
def get_categories():
    """API для получения категорий"""
    categories = {
        "сложные_углеводы": "🌾 Сложные углеводы",
        "простые_углеводы": "⚡ Простые углеводы",
        "белки": "🥩 Белки",
        "ненасыщенные_жиры": "🫒 Ненасыщенные жиры",
        "насыщенные_жиры": "🧈 Насыщенные жиры",
        "клетчатка": "🌿 Клетчатка"
    }
    return jsonify(categories)

@app.route('/api/goals')
def get_goals():
    """API для получения целей"""
    goals = {
        "похудение": "Похудение",
        "набор_массы": "Набор массы",
        "поддержание": "Поддержание формы"
    }
    return jsonify(goals)

if __name__ == '__main__':
    # Получаем порт из переменной окружения (для хостингов)
    port = int(os.environ.get('PORT', 5000))
    app.run(debug=False, host='0.0.0.0', port=port) 